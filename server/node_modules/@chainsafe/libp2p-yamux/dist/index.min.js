(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.ChainsafeLibp2PYamux = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var ChainsafeLibp2PYamux=(()=>{var st=Object.create;var J=Object.defineProperty;var it=Object.getOwnPropertyDescriptor;var ot=Object.getOwnPropertyNames;var at=Object.getPrototypeOf,lt=Object.prototype.hasOwnProperty;var ae=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),ut=(r,e)=>{for(var t in e)J(r,t,{get:e[t],enumerable:!0})},ve=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ot(e))!lt.call(r,s)&&s!==t&&J(r,s,{get:()=>e[s],enumerable:!(n=it(e,s))||n.enumerable});return r};var ct=(r,e,t)=>(t=r!=null?st(at(r)):{},ve(e||!r||!r.__esModule?J(t,"default",{value:r,enumerable:!0}):t,r)),ht=r=>ve(J({},"__esModule",{value:!0}),r);var Ue=ae((sr,Le)=>{var B=1e3,z=B*60,X=z*60,k=X*24,gt=k*7,wt=k*365.25;Le.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return yt(r);if(t==="number"&&isFinite(r))return e.long?Ct(r):Et(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function yt(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*wt;case"weeks":case"week":case"w":return t*gt;case"days":case"day":case"d":return t*k;case"hours":case"hour":case"hrs":case"hr":case"h":return t*X;case"minutes":case"minute":case"mins":case"min":case"m":return t*z;case"seconds":case"second":case"secs":case"sec":case"s":return t*B;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Et(r){var e=Math.abs(r);return e>=k?Math.round(r/k)+"d":e>=X?Math.round(r/X)+"h":e>=z?Math.round(r/z)+"m":e>=B?Math.round(r/B)+"s":r+"ms"}function Ct(r){var e=Math.abs(r);return e>=k?ee(r,e,k,"day"):e>=X?ee(r,e,X,"hour"):e>=z?ee(r,e,z,"minute"):e>=B?ee(r,e,B,"second"):r+" ms"}function ee(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}});var Te=ae((ir,Ne)=>{function St(r){t.debug=t,t.default=t,t.coerce=p,t.disable=i,t.enable=s,t.enabled=l,t.humanize=Ue(),t.destroy=E,Object.keys(r).forEach(a=>{t[a]=r[a]}),t.names=[],t.skips=[],t.formatters={};function e(a){let o=0;for(let h=0;h<a.length;h++)o=(o<<5)-o+a.charCodeAt(h),o|=0;return t.colors[Math.abs(o)%t.colors.length]}t.selectColor=e;function t(a){let o,h=null,_,f;function u(...g){if(!u.enabled)return;let w=u,C=Number(new Date),D=C-(o||C);w.diff=D,w.prev=o,w.curr=C,o=C,g[0]=t.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let S=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(F,A)=>{if(F==="%%")return"%";S++;let O=t.formatters[A];if(typeof O=="function"){let V=g[S];F=O.call(w,V),g.splice(S,1),S--}return F}),t.formatArgs.call(w,g),(w.log||t.log).apply(w,g)}return u.namespace=a,u.useColors=t.useColors(),u.color=t.selectColor(a),u.extend=n,u.destroy=t.destroy,Object.defineProperty(u,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(_!==t.namespaces&&(_=t.namespaces,f=t.enabled(a)),f),set:g=>{h=g}}),typeof t.init=="function"&&t.init(u),u}function n(a,o){let h=t(this.namespace+(typeof o>"u"?":":o)+a);return h.log=this.log,h}function s(a){t.save(a),t.namespaces=a,t.names=[],t.skips=[];let o,h=(typeof a=="string"?a:"").split(/[\s,]+/),_=h.length;for(o=0;o<_;o++)h[o]&&(a=h[o].replace(/\*/g,".*?"),a[0]==="-"?t.skips.push(new RegExp("^"+a.slice(1)+"$")):t.names.push(new RegExp("^"+a+"$")))}function i(){let a=[...t.names.map(c),...t.skips.map(c).map(o=>"-"+o)].join(",");return t.enable(""),a}function l(a){if(a[a.length-1]==="*")return!0;let o,h;for(o=0,h=t.skips.length;o<h;o++)if(t.skips[o].test(a))return!1;for(o=0,h=t.names.length;o<h;o++)if(t.names[o].test(a))return!0;return!1}function c(a){return a.toString().substring(2,a.toString().length-2).replace(/\.\*\?$/,"*")}function p(a){return a instanceof Error?a.stack||a.message:a}function E(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}Ne.exports=St});var Me=ae((I,te)=>{I.formatArgs=Rt;I.save=vt;I.load=_t;I.useColors=xt;I.storage=At();I.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();I.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function xt(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Rt(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+te.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}I.log=console.debug||console.log||(()=>{});function vt(r){try{r?I.storage.setItem("debug",r):I.storage.removeItem("debug")}catch{}}function _t(){let r;try{r=I.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function At(){try{return localStorage}catch{}}te.exports=Te()(I);var{formatters:It}=te.exports;It.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var kt={};ut(kt,{GoAwayCode:()=>R,yamux:()=>Pt});var d=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}};var H=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function _e(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function Q(r,e,t){let n=t??{},s=_e(r);async function*i(){let l,c=()=>{l?.()};for(e.addEventListener("abort",c);;){let p;try{if(e.aborted){let{abortMessage:a,abortCode:o}=n;throw new H(a,o)}let E=new Promise((a,o)=>{l=()=>{let{abortMessage:h,abortCode:_}=n;o(new H(h,_))}});p=await Promise.race([E,s.next()]),l=null}catch(E){e.removeEventListener("abort",c);let a=E.type==="aborted"&&e.aborted;if(a&&n.onAbort!=null&&n.onAbort(r),typeof s.return=="function")try{let o=s.return();o instanceof Promise&&o.catch(h=>{n.onReturnError!=null&&n.onReturnError(h)})}catch(o){n.onReturnError!=null&&n.onReturnError(o)}if(a&&n.returnOnAbort===!0)return;throw E}if(p.done===!0)break;yield p.value}e.removeEventListener("abort",c)}return i()}function Ae(r){let e=new globalThis.AbortController;function t(){e.abort();for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}let s=e.signal;return s.clear=n,s}var Z=class{constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},G=class{constructor(e={}){this.hwm=e.splitLimit??16,this.head=new Z(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new Z(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};function T(r={}){return ft(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function ft(r,e){e=e??{};let t=e.onEnd,n=new G,s,i,l,c=async()=>n.isEmpty()?l?{done:!0}:await new Promise((u,g)=>{i=w=>{i=null,n.push(w);try{u(r(n))}catch(C){g(C)}return s}}):r(n),p=u=>i!=null?i(u):(n.push(u),s),E=u=>(n=new G,i!=null?i({error:u}):(n.push({error:u}),s)),a=u=>{if(l)return s;if(e?.objectMode!==!0&&u?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return p({done:!1,value:u})},o=u=>l?s:(l=!0,u!=null?E(u):p({done:!0})),h=()=>(n=new G,o(),{done:!0}),_=u=>(o(u),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:h,throw:_,push:a,end:o,get readableLength(){return n.size}},t==null)return s;let f=s;return s={[Symbol.asyncIterator](){return this},next(){return f.next()},throw(u){return f.throw(u),t!=null&&(t(u),t=void 0),{done:!0}},return(){return f.return(),t!=null&&(t(),t=void 0),{done:!0}},push:a,end(u){return f.end(u),t!=null&&(t(u),t=void 0),s},get readableLength(){return f.readableLength}},s}function dt(r){return r[Symbol.asyncIterator]!=null}function pt(...r){let e=[];for(let t of r)dt(t)||e.push(t);return e.length===r.length?function*(){for(let t of e)yield*t}():async function*(){let t=T({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(let s of n)t.push(s)})),t.end()}catch(n){t.end(n)}}),yield*t}()}var Ie=pt;function De(r,...e){if(r==null)throw new Error("Empty pipeline");if(le(r)){let n=r;r=()=>n.source}else if(Oe(r)||Fe(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&le(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)le(t[n])&&(t[n]=bt(t[n]));return mt(...t)}var mt=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},Fe=r=>r?.[Symbol.asyncIterator]!=null,Oe=r=>r?.[Symbol.iterator]!=null,le=r=>r==null?!1:r.sink!=null&&r.source!=null,bt=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=T({objectMode:!0});t.then(()=>{n.end()},l=>{n.end(l)});let s,i=r.source;if(Fe(i))s=async function*(){yield*i,n.end()};else if(Oe(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Ie(n,s())}return r.source};var L=ct(Me(),1);function Dt(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),l=i.charCodeAt(0);if(t[l]!==255)throw new TypeError(i+" is ambiguous");t[l]=s}var c=r.length,p=r.charAt(0),E=Math.log(c)/Math.log(256),a=Math.log(256)/Math.log(c);function o(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var u=0,g=0,w=0,C=f.length;w!==C&&f[w]===0;)w++,u++;for(var D=(C-w)*a+1>>>0,S=new Uint8Array(D);w!==C;){for(var U=f[w],F=0,A=D-1;(U!==0||F<g)&&A!==-1;A--,F++)U+=256*S[A]>>>0,S[A]=U%c>>>0,U=U/c>>>0;if(U!==0)throw new Error("Non-zero carry");g=F,w++}for(var O=D-g;O!==D&&S[O]===0;)O++;for(var V=p.repeat(u);O<D;++O)V+=r.charAt(S[O]);return V}function h(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var u=0;if(f[u]!==" "){for(var g=0,w=0;f[u]===p;)g++,u++;for(var C=(f.length-u)*E+1>>>0,D=new Uint8Array(C);f[u];){var S=t[f.charCodeAt(u)];if(S===255)return;for(var U=0,F=C-1;(S!==0||U<w)&&F!==-1;F--,U++)S+=c*D[F]>>>0,D[F]=S%256>>>0,S=S/256>>>0;if(S!==0)throw new Error("Non-zero carry");w=U,u++}if(f[u]!==" "){for(var A=C-w;A!==C&&D[A]===0;)A++;for(var O=new Uint8Array(g+(C-A)),V=g;A!==C;)O[V++]=D[A++];return O}}}function _(f){var u=h(f);if(u)return u;throw new Error(`Non-${e} character`)}return{encode:o,decodeUnsafe:h,decode:_}}var Ft=Dt,Ot=Ft,We=Ot;var ar=new Uint8Array(0);var Pe=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var ue=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ce=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return ke(this,e)}},he=class{constructor(e){this.decoders=e}or(e){return ke(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},ke=(r,e)=>new he({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),fe=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new ue(e,t,n),this.decoder=new ce(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Ve=({name:r,prefix:e,encode:t,decode:n})=>new fe(r,e,t,n),de=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=We(t,e);return Ve({prefix:r,name:e,encode:n,decode:i=>Pe(s(i))})},Lt=(r,e,t,n)=>{let s={};for(let a=0;a<e.length;++a)s[e[a]]=a;let i=r.length;for(;r[i-1]==="=";)--i;let l=new Uint8Array(i*t/8|0),c=0,p=0,E=0;for(let a=0;a<i;++a){let o=s[r[a]];if(o===void 0)throw new SyntaxError(`Non-${n} character`);p=p<<t|o,c+=t,c>=8&&(c-=8,l[E++]=255&p>>c)}if(c>=t||255&p<<8-c)throw new SyntaxError("Unexpected end of data");return l},Ut=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,i="",l=0,c=0;for(let p=0;p<r.length;++p)for(c=c<<8|r[p],l+=8;l>t;)l-=t,i+=e[s&c>>l];if(l&&(i+=e[s&c<<t-l]),n)for(;i.length*t&7;)i+="=";return i},x=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Ve({prefix:e,name:r,encode(s){return Ut(s,n,t)},decode(s){return Lt(s,n,t,r)}});var Ge=de({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),dr=de({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Be=x({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),br=x({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),gr=x({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),wr=x({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),yr=x({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Er=x({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Cr=x({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Sr=x({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),xr=x({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var ze=x({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),_r=x({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Ar=x({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ir=x({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});L.default.formatters.b=r=>r==null?"undefined":Ge.baseEncode(r);L.default.formatters.t=r=>r==null?"undefined":Be.baseEncode(r);L.default.formatters.m=r=>r==null?"undefined":ze.baseEncode(r);L.default.formatters.p=r=>r==null?"undefined":r.toString();L.default.formatters.c=r=>r==null?"undefined":r.toString();L.default.formatters.k=r=>r==null?"undefined":r.toString();function Nt(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Xe(r){let e=Nt(`${r}:trace`);return L.default.enabled(`${r}:trace`)&&L.default.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=(0,L.default)(`${r}:trace`)),Object.assign((0,L.default)(r),{error:(0,L.default)(`${r}:error`),trace:e})}var Y="ERR_INVALID_FRAME",pe="ERR_UNREQUESTED_PING",me="ERR_NOT_MATCHING_PING",be="ERR_STREAM_ALREADY_EXISTS",ge="ERR_DECODE_INVALID_VERSION",we="ERR_BOTH_CLIENTS",ye="ERR_RECV_WINDOW_EXCEEDED",Ye=new Set([Y,pe,me,be,ge,we,ye]),M="ERR_INVALID_CONFIG",re="ERR_MUXER_LOCAL_CLOSED",Ee="ERR_MUXER_REMOTE_CLOSED",He="ERR_STREAM_RESET",q="ERR_STREAM_ABORT",qe="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",$e="ERR_DECODE_IN_PROGRESS",$=256*1024,je=16*1024*1024;var Ke={log:Xe("libp2p:yamux"),enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:$,maxStreamWindowSize:je,maxMessageSize:64*1024};function Je(r){if(r.keepAliveInterval<=0)throw new d("keep-alive interval must be positive",M);if(r.maxInboundStreams<0)throw new d("max inbound streams must be larger or equal 0",M);if(r.maxOutboundStreams<0)throw new d("max outbound streams must be larger or equal 0",M);if(r.initialStreamWindowSize<$)throw new d("InitialStreamWindowSize must be larger or equal 256 kB",M);if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new d("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",M);if(r.maxStreamWindowSize>2**32-1)throw new d("MaxStreamWindowSize must be less than equal MAX_UINT32",M);if(r.maxMessageSize<1024)throw new d("MaxMessageSize must be greater than a kilobyte",M)}function j(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}function N(r=0){return globalThis.Buffer?.alloc!=null?j(globalThis.Buffer.alloc(r)):new Uint8Array(r)}function K(r=0){return globalThis.Buffer?.allocUnsafe!=null?j(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function Ce(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));let t=K(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return j(t)}function Qe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var et=Symbol.for("@achingbrain/uint8arraylist");function Ze(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function ne(r){return!!r?.[et]}var W=class{constructor(...e){Object.defineProperty(this,et,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(ne(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(ne(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=Ze(this.bufs,e);return t.buf[t.index]}set(e,t){let n=Ze(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(ne(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:s}=this._subList(e,t);return Ce(n,s)}subarray(e,t){let{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:Ce(n,s)}sublist(e,t){let{bufs:n,length:s}=this._subList(e,t),i=new W;return i.length=s,i.bufs=n,i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};let n=[],s=0;for(let i=0;i<this.bufs.length;i++){let l=this.bufs[i],c=s,p=c+l.byteLength;if(s=p,e>=p)continue;let E=e>=c&&e<p,a=t>c&&t<=p;if(E&&a){if(e===c&&t===p){n.push(l);break}let o=e-c;n.push(l.subarray(o,o+(t-e)));break}if(E){if(e===0){n.push(l);continue}n.push(l.subarray(e-c));continue}if(a){if(t===p){n.push(l);break}n.push(l.subarray(0,t-c));break}n.push(l)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!ne(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let i=256,l=new Int32Array(i);for(let o=0;o<i;o++)l[o]=-1;for(let o=0;o<s;o++)l[n[o]]=o;let c=l,p=this.byteLength-n.byteLength,E=n.byteLength-1,a;for(let o=t;o<=p;o+=a){a=0;for(let h=E;h>=0;h--){let _=this.get(o+h);if(n[h]!==_){a=Math.max(1,h-c[_]);break}}if(a===0)return o}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=K(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let s=N(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let s=N(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let s=N(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=K(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let s=N(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let s=N(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let s=N(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let s=N(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let s=N(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof W)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!Qe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new W;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}};var b;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(b||(b={}));var m;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(m||(m={}));var Tt=Object.values(m).filter(r=>typeof r!="string"),tt=0,R;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(R||(R={}));var P=12;function Se(r){let e=Tt.filter(t=>(r.flag&t)===t).map(t=>m[t]).join("|");return`streamID=${r.streamID} type=${b[r.type]} flag=${e} length=${r.length}`}var rt=2**24;function Mt(r){if(r[0]!==tt)throw new d("Invalid frame version",ge);return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*rt+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*rt+(r[9]<<16)+(r[10]<<8)+r[11]}}var se=class{source;buffer;frameInProgress;constructor(e){this.source=Wt(e),this.buffer=new W,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:s}=t;n===b.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new d("decoding frame already in progress",$e);if(this.buffer.length<P)return;let e=Mt(this.buffer.subarray(0,P));return this.buffer.consume(P),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function Wt(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function xe(r){let e=new Uint8Array(P);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var y;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(y||(y={}));var v;(function(r){r[r.Open=0]="Open",r[r.Closed=1]="Closed",r[r.Reset=2]="Reset"})(v||(v={}));var ie=class{id;name;stat;metadata;state;readState;writeState;sourceInput;source;sink;config;log;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;abortController;sendFrame;onStreamEnd;constructor(e){this.config=e.config,this.log=e.log,this._id=e.id,this.id=String(e.id),this.name=e.name,this.stat={direction:e.direction,timeline:{open:Date.now()}},this.metadata={},this.state=e.state,this.readState=v.Open,this.writeState=v.Open,this.sendWindowCapacity=$,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.abortController=new AbortController,this.sendFrame=e.sendFrame,this.onStreamEnd=e.onStreamEnd,this.sourceInput=T({onEnd:t=>{t!=null?this.log?.error("stream source ended id=%s",this._id,t):this.log?.trace("stream source ended id=%s",this._id),this.closeRead()}}),this.source=this.createSource(),this.sink=async t=>{if(this.writeState!==v.Open)throw new Error("stream closed for writing");t=Q(t,this.abortController.signal,{returnOnAbort:!0});try{for await(let n of t)for(;n.length!==0;){this.sendWindowCapacity===0&&await this.waitForSendWindowCapacity();let s=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-P,n.length);this.sendData(n.subarray(0,s)),this.sendWindowCapacity-=s,n=n.subarray(s)}}catch(n){this.log?.error("stream sink error id=%s",this._id,n)}finally{this.log?.trace("stream sink ended id=%s",this._id),this.closeWrite()}}}async*createSource(){try{for await(let e of this.sourceInput)this.sendWindowUpdate(),yield e}catch(e){if(e.code!==q)throw this.log?.error("stream source error id=%s",this._id,e),e}}close(){this.log?.trace("stream close id=%s",this._id),this.closeRead(),this.closeWrite()}closeRead(){this.state!==y.Finished&&this.readState===v.Open&&(this.log?.trace("stream close read id=%s",this._id),this.readState=v.Closed,this.sourceInput.end(),this.writeState!==v.Open&&this.finish())}closeWrite(){this.state!==y.Finished&&this.writeState===v.Open&&(this.log?.trace("stream close write id=%s",this._id),this.writeState=v.Closed,this.sendClose(),this.abortController.abort(),this.readState!==v.Open&&this.finish())}abort(e){switch(this.state){case y.Finished:return;case y.Init:break;case y.SYNSent:case y.SYNReceived:case y.Established:this.sendReset();break;default:throw new Error("unreachable")}e!=null?this.log?.error("stream abort id=%s error=%s",this._id,e):this.log?.trace("stream abort id=%s",this._id),this.onReset(new d(String(e)??"stream aborted",q))}reset(){this.state!==y.Finished&&(this.log?.trace("stream reset id=%s",this._id),this.onReset(new d("stream reset",He)))}onReset(e){this.writeState===v.Open&&(this.writeState=v.Reset),this.readState===v.Open&&(this.readState=v.Reset),this.state=y.Finished,this.sourceInput.end(e),this.abortController.abort(),this.finish()}async waitForSendWindowCapacity(){if(this.abortController.signal.aborted)throw new d("stream aborted",q);if(this.sendWindowCapacity>0)return;let e,t=()=>{e(new d("stream aborted",q))};this.abortController.signal.addEventListener("abort",t),await new Promise((n,s)=>{this.sendWindowCapacityUpdate=()=>{this.abortController.signal.removeEventListener("abort",t),n(void 0)},e=s})}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new d("receive window exceeded",ye,{available:this.recvWindowCapacity,recv:e.length});let n=await t();this.recvWindowCapacity-=e.length,this.sourceInput.push(n)}processFlags(e){(e&m.ACK)===m.ACK&&this.state===y.SYNSent&&(this.state=y.Established),(e&m.FIN)===m.FIN&&this.closeRead(),(e&m.RST)===m.RST&&this.reset()}finish(){this.log?.trace("stream finished id=%s",this._id),this.state=y.Finished,this.stat.timeline.close=Date.now(),this.onStreamEnd()}getSendFlags(){switch(this.state){case y.Init:return this.state=y.SYNSent,m.SYN;case y.SYNReceived:return this.state=y.Established,m.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>0&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:b.WindowUpdate,flag:e,streamID:this._id,length:s})}sendData(e){let t=this.getSendFlags();this.sendFrame({type:b.Data,flag:t,streamID:this._id,length:e.length},e)}sendClose(){let e=this.getSendFlags()|m.FIN;this.sendFrame({type:b.WindowUpdate,flag:e,streamID:this._id,length:0})}sendReset(){this.sendFrame({type:b.WindowUpdate,flag:m.RST,streamID:this._id,length:0})}};var nt="/yamux/1.0.0",oe=class{protocol=nt;_init;constructor(e={}){this._init=e}createStreamMuxer(e){return new Re({...this._init,...e})}},Re=class{protocol=nt;source;sink;_init;config;log;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e){this._init=e,this.client=e.direction==="outbound",this.config={...Ke,...e},this.log=this.config.log,Je(this.config),this.closeController=new AbortController,this.onIncomingStream=e.onIncomingStream,this.onStreamEnd=e.onStreamEnd,this._streams=new Map,this.source=T({onEnd:t=>{this.log?.trace("muxer source ended"),this.close(t)}}),this.sink=async t=>{let n;this._init.signal!=null&&(n=Ae([this.closeController.signal,this._init.signal])),t=Q(t,n??this.closeController.signal,{returnOnAbort:!0});let s,i;try{let l=new se(t);await De(l.emitFrames.bind(l),async c=>{for await(let{header:p,readData:E}of c)await this.handleFrame(p,E)}),s=R.NormalTermination}catch(l){let c=l.code;Ye.has(c)?(this.log?.error("protocol error in sink",l),s=R.ProtocolError):(this.log?.error("internal error in sink",l),s=R.InternalError),i=l}finally{n?.clear()}this.log?.trace("muxer sink ended"),this.close(i,s)},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=0,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(t=>this.log?.error("keepalive error: %s",t))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new d("muxer closed remotely",Ee);if(this.localGoAway!==void 0)throw new d("muxer closed locally",re);let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new d("max outbound streams exceeded",qe);this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,y.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new d("muxer closed remotely",Ee);if(this.localGoAway!==void 0)throw new d("muxer closed locally",re);if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{let l=()=>{i(new d("muxer closed locally",re))};this.closeController.signal.addEventListener("abort",l,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",l),s()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}close(e,t){if(!this.closeController.signal.aborted){if(t=t??(e===void 0?R.InternalError:R.NormalTermination),e!=null?this.log?.error("muxer close reason=%s error=%s",R[t],e):this.log?.trace("muxer close reason=%s",R[t]),e===void 0)for(let n of this._streams.values())n.close();else for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new d("Stream already exists",be,{id:e});let i=new ie({id:e,name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onStreamEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.log,config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){let{streamID:n,type:s,length:i}=e;if(this.log?.trace("received frame %s",Se(e)),n===0)switch(s){case b.Ping:{this.handlePing(e);return}case b.GoAway:{this.handleGoAway(i);return}default:throw new d("Invalid frame type",Y,{header:e})}else switch(e.type){case b.Data:case b.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new d("Invalid frame type",Y,{header:e})}}handlePing(e){if(e.flag===m.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,m.ACK);else if(e.flag===m.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new d("Invalid frame flag",Y,{header:e})}handlePingResponse(e){if(this.activePing===void 0)throw new d("ping not requested",pe);if(this.activePing.id!==e)throw new d("ping doesn't match our id",me);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",R[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:s,type:i}=e;(s&m.SYN)===m.SYN&&this.incomingStream(n);let l=this._streams.get(n);if(l===void 0){if(i===b.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",n);return}switch(i){case b.WindowUpdate:{l.handleWindowUpdate(e);return}case b.Data:{if(t===void 0)throw new Error("unreachable");await l.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new d("both endpoints are clients",we);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:b.WindowUpdate,flag:m.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:b.WindowUpdate,flag:m.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,y.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %s",Se(e)),e.type===b.Data){if(t===void 0)throw new d("invalid frame",Y);this.source.push(xe(e)),this.source.push(t)}else this.source.push(xe(e))}sendPing(e,t=m.SYN){t===m.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:b.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=R.NormalTermination){this.log?.("sending GoAway reason=%s",R[e]),this.localGoAway=e,this.sendFrame({type:b.GoAway,flag:0,streamID:0,length:e})}};function Pt(r={}){return()=>new oe(r)}return ht(kt);})();
return ChainsafeLibp2PYamux}));
